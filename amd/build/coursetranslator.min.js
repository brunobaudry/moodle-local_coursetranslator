define("local_coursetranslator/coursetranslator",["exports","core/ajax"],(function(_exports,_ajax){var obj;
/*
   * @module     local_coursetranslator/coursetranslator
   * @copyright  2022 Kaleb Heitzman <kaleb@jamfire.io>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};_exports.init=config=>{window.console.log(config.userPrefs),window.console.log(config.ed);let editorType=config.userPrefs.htmleditor,tempTranslations={};const searchex=/{\s*mlang\s+((?:[a-z0-9_-]+)(?:\s*,\s*[a-z0-9_-]+\s*)*)\s*}(.*?){\s*mlang\s*}/dgis,mlangparser=text=>{if(null===text.match(searchex))return text;let result=text.replace(searchex,(match=>((lang,match)=>{let blocklang=match.split(searchex)[1],blocktext=match.split(searchex)[2];return blocklang===lang?blocktext:""})(config.lang,match)));if(0===result.length){let mlangex=new RegExp("{mlang other}(.*?){mlang}","dgis"),matches=text.match(mlangex);if(matches[0].split(searchex)[2])return matches[0].split(searchex)[2]}return result};document.querySelector(".local-coursetranslator__localeswitcher").addEventListener("change",(e=>{let url=new URL(window.location.href);url.searchParams.set("course_lang",e.target.value);let newUrl=url.toString();window.location=newUrl})),document.querySelector(".local-coursetranslator__show-updated").addEventListener("change",(e=>{let items=document.querySelectorAll('[data-status="updated"]');e.target.checked?items.forEach((item=>{item.classList.remove("d-none")})):items.forEach((item=>{item.classList.add("d-none")}))})),document.querySelector(".local-coursetranslator__show-needsupdate").addEventListener("change",(e=>{let items=document.querySelectorAll('[data-status="needsupdate"]');e.target.checked?items.forEach((item=>{item.classList.remove("d-none")})):items.forEach((item=>{item.classList.add("d-none")}))}));const selectAll=document.querySelector(".local-coursetranslator__select-all");config.autotranslate&&(selectAll.disabled=!1),selectAll.addEventListener("click",(e=>{let checked=e.target.checked,checkboxes=document.querySelectorAll(".local-coursetranslator__checkbox");checked?checkboxes.forEach((e=>{e.checked=!0})):checkboxes.forEach((e=>{e.checked=!1})),toggleAutotranslateButton()}));document.querySelectorAll("[data-key-validator]").forEach((e=>{e.addEventListener("click",(e=>{let key=e.target.parentElement.dataset.keyValidator,editor=findEditor(key);window.console.log(key),window.console.log(editor),window.console.log(editor.innerHTML)}))}));const checkboxes=document.querySelectorAll(".local-coursetranslator__checkbox");config.autotranslate&&checkboxes.forEach((e=>{e.disabled=!1})),checkboxes.forEach((e=>{e.addEventListener("change",(()=>{toggleAutotranslateButton()}))}));const autotranslateButton=document.querySelector(".local-coursetranslator__autotranslate-btn"),toggleAutotranslateButton=()=>{let checkboxItems=[];checkboxes.forEach((e=>{checkboxItems.push(e.checked)}));let checked=!!checkboxItems.find((checked=>!0===checked));config.autotranslate&&checked?autotranslateButton.disabled=!1:autotranslateButton.disabled=!0};autotranslateButton.addEventListener("click",(()=>{document.querySelectorAll(".local-coursetranslator__checkbox:checked").forEach((e=>{let key=e.getAttribute("data-key");getTranslation(key)}))}));const findEditor=key=>{switch(window.console.log("document.querySelector('')"),window.console.log("editors pref : "+editorType),editorType){case"atto":return document.querySelectorAll('.local-coursetranslator__editor[data-key="'+key+'"] [contenteditable="true"]');case"tiny":return document.querySelector('.local-coursetranslator__editor[data-key="'+key+'"] iframe').contentWindow.tinymce;case"textarea":return document.querySelector('.local-coursetranslator__editor[data-key="'+key+'"] textarea[name="'+key+'[text]"]')}return document.querySelectorAll("")},getTranslation=key=>{tempTranslations[key]={};let editor=findEditor(key),sourceText=document.querySelector('[data-sourcetext-key="'+key+'"]').innerHTML;tempTranslations[key]={editor:editor,source:sourceText,translation:""};let formData=new FormData;formData.append("text",sourceText),formData.append("source_lang",config.currentlang),formData.append("target_lang",config.lang),formData.append("preserve_formatting",1),formData.append("auth_key",config.apikey),formData.append("tag_handling","xml"),formData.append("split_sentences","nonewlines"),window.console.log(config.currentlang),window.console.log("Send deepl:",formData);let xhr=new XMLHttpRequest;xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.DONE){var status=xhr.status;if(0===status||status>=200&&status<400){let data=JSON.parse(xhr.responseText);window.console.log("deepl:",key,data),window.console.log(config.currentlang),editor.innerHTML=data.translations[0].text,tempTranslations[key].translation=data.translations[0].text}else window.console.log("error",status)}},xhr.open("POST",config.deeplurl),xhr.send(formData)},saveTranslation=(key,editor,text)=>{let element=editor.closest(".local-coursetranslator__editor"),id=element.getAttribute("data-id"),tid=element.getAttribute("data-tid"),table=element.getAttribute("data-table"),field=element.getAttribute("data-field"),fielddata={};fielddata.courseid=config.courseid,fielddata.id=parseInt(id),fielddata.table=table,fielddata.field=field,_ajax.default.call([{methodname:"local_coursetranslator_get_field",args:{data:[fielddata]},done:data=>{let fieldtext=data[0].text;if(data.length>0){let textarea=document.querySelector('.local-coursetranslator__textarea[data-key="'+key+'"]'),updatedtext=getupdatedtext(fieldtext,text),tdata={};tdata.courseid=config.courseid,tdata.id=parseInt(id),tdata.tid=tid,tdata.table=table,tdata.field=field,tdata.text=updatedtext;const successMessage=()=>{editor.classList.add("local-coursetranslator__success");let indicator='<div class="local-coursetranslator__success-message" data-key="'+key+'">'+config.autosavedmsg+"</div>";editor.after(...(string=>{if((()=>{if(!window.DOMParser)return!1;var parser=new DOMParser;try{parser.parseFromString("x","text/html")}catch(err){return!1}return!0})())return(new DOMParser).parseFromString(string,"text/html").body.childNodes;var dom=document.createElement("div");return dom.innerHTML=string,dom})(indicator));let status=document.querySelector('[data-status-key="'+key+'"');status.classList.replace("badge-danger","badge-success"),status.innerHTML=config.uptodate,setTimeout((()=>{let indicatorNode=document.querySelector('.local-coursetranslator__success-message[data-key="'+key+'"]');editor.parentNode.removeChild(indicatorNode)}),3e3)},errorMessage=error=>{window.console.log(error),editor.classList.add("local-coursetranslator__error")};_ajax.default.call([{methodname:"local_coursetranslator_update_translation",args:{data:[tdata]},done:data=>{config.debug>0&&window.console.log("ws: ",key,data),data.length>0?(successMessage(),textarea.innerHTML=data[0].text,config.currentlang===config.lang&&(document.querySelector('[data-sourcetext-key="'+key+'"]').innerHTML=text)):errorMessage()},fail:error=>{errorMessage(error)}}])}else window.console.log(data)},fail:error=>{window.console.log(error)}}])},getupdatedtext=(fieldtext,text)=>{let lang=config.lang,mlangtext="{mlang "+lang+"}"+text+"{mlang}";if(-1===fieldtext.indexOf("{mlang"))return"other"===lang?mlangtext:"{mlang other}"+fieldtext+"{mlang}{mlang "+lang+"}"+text+"{mlang}";let replacex=new RegExp(`{*mlang +(${lang})}(.*?){*mlang*}`,"dgis");return fieldtext.match(replacex)?fieldtext.replace(replacex,"{mlang "+lang+"}"+text+"{mlang}"):fieldtext+"{mlang "+lang+"}"+text+"{mlang}"};window.addEventListener("load",(()=>{document.querySelectorAll('.local-coursetranslator__editor [contenteditable="true"]').forEach((editor=>{editor.addEventListener("focusout",(()=>{let text=editor.innerHTML,key=editor.closest(".local-coursetranslator__editor").getAttribute("data-key");saveTranslation(key,editor,text)})),editor.addEventListener("click",(()=>{editor.classList.remove("local-coursetranslator__success"),editor.classList.remove("local-coursetranslator__error")}))}))})),window.addEventListener("load",(()=>{document.querySelectorAll(".local-coursetranslator__textarea").forEach((textarea=>{let key=textarea.getAttribute("data-key"),text=textarea.innerHTML,editor=document.querySelector('[data-key="'+key+'"] [contenteditable="true"]'),langpattern="{mlang "+config.lang+"}(.*?){mlang}",langex=new RegExp(langpattern,"dgis"),matches=text.match(langex),parsedtext=mlangparser(text);if(matches&&1===matches.length)editor.innerHTML=parsedtext;else if(matches&&matches.length>1){document.querySelector('input[type="checkbox"][data-key="'+key+'"]').remove(),document.querySelector('.local-coursetranslator__editor[data-key="'+key+'"] > *').remove(),document.querySelector('.local-coursetranslator__textarea[data-key="'+key+'"]').remove();let p=document.createElement("p");p.innerHTML="<em><small>"+config.multiplemlang+"</small></em>",(void 0).document.querySelector('.local-coursetranslator__editor[data-key="'+key+'"]').append(p)}else editor.innerHTML=parsedtext}))}))}}));

//# sourceMappingURL=coursetranslator.min.js.map