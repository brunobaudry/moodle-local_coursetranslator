{"version":3,"file":"coursetranslator.min.js","sources":["../src/coursetranslator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @module     local_coursetranslator/coursetranslator\n * @copyright  2022 Kaleb Heitzman <kaleb@jamfire.io>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n// import libs\nimport ajax from \"core/ajax\";\nimport Selectors from \"./selectors\";\nimport Modal from 'core/modal';\n// Initialize the temporary translations dictionary @todo make external class\nlet tempTranslations = {};\nlet editorType = '';\nlet config = {};\nlet autotranslateButton = {};\nlet checkboxes = [];\n\nconst registerEventListeners = ()=>{\n  document.addEventListener('change', e=>{\n    if (e.target.closest(Selectors.actions.targetSwitcher)) {\n      switchTarget(e);\n    }\n    if (e.target.closest(Selectors.actions.sourceSwitcher)) {\n      switchSource(e);\n    }\n    if (e.target.closest(Selectors.actions.showUpdated)) {\n      showUpdated(e);\n    }\n    if (e.target.closest(Selectors.actions.showNeedUpdate)) {\n      neededUpdate(e);\n    }\n  });\n  document.addEventListener('click', e=>{\n    if (e.target.closest(Selectors.actions.autoTranslateBtn)) {\n      if(config.currentlang == config.lang || config.lang == undefined){\n        Modal.create({\n          title: 'Cannot call deepl',\n          body: `<p>Both languges are the same {$config.lang}</p>`,\n          show: true,\n          removeOnClose: true,\n        });\n      }else{\n        doAutotranslate(e);\n      }\n    }\n    if (e.target.closest(Selectors.actions.selecAllBtn)) {\n      selectAll(e);\n    }\n  });\n};\nconst registerUI = ()=>{\n  autotranslateButton = document.querySelector(Selectors.actions.autoTranslateBtn);\n  checkboxes = document.querySelectorAll(Selectors.actions.checkBoxes);\n  window.console.log(Selectors.statuses.checkedCheckBoxes);\n};\n\n/**\n * Translation Editor UI\n * @param {Object} cfg JS Config\n */\nexport const init = (cfg) => {\n  config = cfg;\n  // Window.console.log(config.userPrefs);\n  editorType = config.userPrefs;\n\n  registerUI();\n  registerEventListeners();\n\n  /**\n   * Convert a template string into HTML DOM nodes\n   * @param  {String} string The template string\n   * @return {Node}       The template HTML\n   */\n  const stringToHTML = (string) => {\n    // See if DOMParser is supported\n    let parser;\n    const support = (() => {\n      if (!window.DOMParser) {\n        return false;\n      }\n      parser = new DOMParser();\n      try {\n        parser.parseFromString(\"x\", \"text/html\");\n      } catch (err) {\n        return false;\n      }\n      return true;\n    })();\n    // If DOMParser is supported, use it\n    if (support) {\n      parser = new DOMParser();\n      const doc = parser.parseFromString(string, \"text/html\");\n      return doc.body.childNodes;\n    }\n    // Otherwise, fallback to old-school method\n    const dom = document.createElement(\"div\");\n    dom.innerHTML = string;\n    return dom;\n  };\n\n  /**\n   * {mlang} searchex regex\n   */\n  const searchex =\n    /{\\s*mlang\\s+((?:[a-z0-9_-]+)(?:\\s*,\\s*[a-z0-9_-]+\\s*)*)\\s*}(.*?){\\s*mlang\\s*}/dgis;\n\n  /**\n   * Search for mlang tags\n   *\n   * The code for this js parser was adapted from filter/multilang2\n   *\n   * @param {string} text Text with {mlang}\n   * @returns {string}\n   */\n  const mlangparser = (text) => {\n    // Search for {mlang} not found.\n    if (text.match(searchex) === null) {\n      return text;\n    }\n    // Replace callback for searchex results.\n    const replacecallback = (lang, match) => {\n      let blocklang = match.split(searchex)[1];\n      let blocktext = match.split(searchex)[2];\n      if (blocklang === lang) {\n        return blocktext;\n      } else {\n        return \"\";\n      }\n    };\n\n    // Get searchex results.\n    let result = text.replace(searchex, (match) => {\n      let lang = config.lang;\n      return replacecallback(lang, match);\n    });\n\n    // No results were found, return text in mlang other\n    if (result.length === 0) {\n      let mlangpattern = \"{mlang other}(.*?){mlang}\";\n      let mlangex = new RegExp(mlangpattern, \"dgis\");\n      let matches = text.match(mlangex);\n      if (matches[0].split(searchex)[2]) {\n        return matches[0].split(searchex)[2];\n      }\n    }\n\n    // Return the found string.\n    return result;\n  };\n\n  if (config.autotranslate) {\n    selectAll.disabled = false;\n  }\n\n  /**\n   * Validaate translation ck\n   */\n  // const validators = document.querySelectorAll(\"[data-key-validator]\");\n  const validators = document.querySelectorAll(Selectors.actions.validatorsBtns);\n  validators.forEach((e)=>{\n    // Get the stored data and do the saving from editors content\n    e.addEventListener('click', (e)=> {\n      let key = e.target.parentElement.dataset.keyValidator;\n      if (tempTranslations[key] === null || tempTranslations[key] === undefined) {\n        /**\n         * @todo do a UI feedback (disable save )\n         */\n        window.console.log(`Transaltion key \"${key}\" is undefined `);\n      } else {\n        saveTranslation(\n            key,\n            tempTranslations[key].editor,\n            tempTranslations[key].editor.innerHTML\n        );\n      }\n\n    });\n  });\n\n  /**\n   * Autotranslate Checkboxes\n   */\n  /*const checkboxes = document.querySelectorAll(\n    \".local-coursetranslator__checkbox\"\n  );*/\n  //window.console.log(config, config.autotranslate, checkboxes);\n  if (config.autotranslate) {\n    checkboxes.forEach((e) => {\n      //window.console.log(e);\n      e.disabled = false;\n    });\n  }\n  checkboxes.forEach((e) => {\n    e.addEventListener(\"change\", () => {\n      toggleAutotranslateButton();\n    });\n  });\n\n\n  /**\n   * Save Translation to Moodle\n   * @param  {String} key Data Key\n   * @param  {Node} editor HTML Editor Node\n   * @param  {String} text Updated Text\n   * @todo 3rd param is to refactor remove as it is the editors content\n   */\n  const saveTranslation = (key, editor, text) => {\n\n    // Get processing vars\n    // let element = editor.closest(\".local-coursetranslator__editor\");\n    let element = editor.closest(Selectors.editors.all);\n    //let element = editor;\n    let id = element.getAttribute(\"data-id\");\n    let tid = element.getAttribute(\"data-tid\");\n    let table = element.getAttribute(\"data-table\");\n    let field = element.getAttribute(\"data-field\");\n\n    // Get the latest field data\n    let fielddata = {};\n    fielddata.courseid = config.courseid;\n    fielddata.id = parseInt(id);\n    fielddata.table = table;\n    fielddata.field = field;\n\n    // Get the latest data to parse text against.\n    ajax.call([\n      {\n        methodname: \"local_coursetranslator_get_field\",\n        args: {\n          data: [fielddata],\n        },\n        done: (data) => {\n          // The latests field text so multiple translators can work at the same time\n          let fieldtext = data[0].text;\n\n          // Field text exists\n          if (data.length > 0) {\n            // Updated hidden textarea with updatedtext\n            let textarea = document.querySelector(\n                Selectors.editors.multiples.textAreas\n                    .replace(\"<KEY>\", key));\n            // Get the updated text\n            let updatedtext = getupdatedtext(fieldtext, text);\n\n            // Build the data object\n            let tdata = {};\n            tdata.courseid = config.courseid;\n            tdata.id = parseInt(id);\n            tdata.tid = tid;\n            tdata.table = table;\n            tdata.field = field;\n            tdata.text = updatedtext;\n            window.console.log(tdata);\n            // Success Message\n            const successMessage = () => {\n              editor.classList.add(\"local-coursetranslator__success\");\n              // Add saved indicator\n              let indicator =\n                `<div \n                   class=\"local-coursetranslator__success-message\" \n                   data-status=\"local-coursetranslator/success-message\" \n                   data-key=\"${key}\"\n                 >${config.autosavedmsg}</div>`;\n              editor.after(...stringToHTML(indicator));\n\n              let status = document.querySelector(\n                  Selectors.statuses.keys\n                      .replace(\"<KEY>\",key));\n              status.classList.replace(\"badge-danger\", \"badge-success\");\n              status.innerHTML = config.uptodate;\n\n              // Remove success message after a few seconds\n              setTimeout(() => {\n                let indicatorNode = document.querySelector(\n                    Selectors.statuses.successMessages\n                        .replace(\"<KEY>\",key));\n                editor.parentNode.removeChild(indicatorNode);\n              }, 3000);\n            };\n\n            // Error Mesage\n            const errorMessage = (error) => {\n              window.console.log(error);\n              editor.classList.add(\"local-coursetranslator__error\");\n            };\n\n            // Submit the request\n            ajax.call([\n              {\n                methodname: \"local_coursetranslator_update_translation\",\n                args: {\n                  data: [tdata],\n                },\n                done: (data) => {\n                  // Print response to console log\n                  if (config.debug > 0) {\n                    window.console.log(\"ws: \", key, data);\n                  }\n\n                  // Display success message\n                  if (data.length > 0) {\n                    successMessage();\n                    textarea.innerHTML = data[0].text;\n\n                    // Update source lang if necessary\n                    if (config.currentlang === config.lang) {\n                      document.querySelector(Selectors.sourcetexts.keys.replace('<KEY>', key))\n                          .innerHTML = text;\n                    }\n                  } else {\n                    // Something went wrong with the data\n                    errorMessage();\n                  }\n                },\n                fail: (error) => {\n                  // An error occurred\n                  errorMessage(error);\n                },\n              },\n            ]);\n          } else {\n            // Something went wrong with field retrieval\n            window.console.log(data);\n          }\n        },\n        fail: (error) => {\n          // An error occurred\n          window.console.log(error);\n        },\n      },\n    ]);\n  };\n\n  /**\n   * Update Textarea\n   * @param {string} fieldtext Latest text from database\n   * @param {string} text Text to update\n   * @returns {string}\n   */\n  const getupdatedtext = (fieldtext, text) => {\n    let lang = config.lang;\n\n    // Search for {mlang} not found.\n    let mlangtext = `{mlang ${lang}}${text}{mlang}`;\n\n    // Return new mlang text if mlang has not been used before\n    if (fieldtext.indexOf(\"{mlang\") === -1) {\n      if (lang === \"other\") {\n        return mlangtext;\n      } else {\n        return (\n          `{mlang other} ${fieldtext} {mlang}{mlang ${lang}} ${text} {mlang}`\n        );\n      }\n    }\n\n    // Use regex to replace the string\n    let pattern = `{*mlang +(${lang})}(.*?){*mlang*}`;\n    let replacex = new RegExp(pattern, \"dgis\");\n    let matches = fieldtext.match(replacex);\n\n    // Return the updated string\n    const updatedString = `{mlang ${lang}} ${text} {mlang}`;\n    if (matches) {\n      return fieldtext.replace(replacex, updatedString);\n    } else {\n      return fieldtext + updatedString;\n    }\n  };\n\n  /**\n   * Get the Translation using Moodle Web Service\n   * @returns void\n   */\n  window.addEventListener(\"load\", () => {\n    // document.querySelectorAll('.local-coursetranslator__editor [contenteditable=\"true\"]')\n    document.querySelectorAll(Selectors.editors.contentEditable)\n      .forEach((editor) => {\n        // Save translation\n        editor.addEventListener(\"focusout\", () => {\n          // Get Processing Information\n          let text = editor.innerHTML;\n          // let element = editor.closest(\".local-coursetranslator__editor\");\n          let element = editor.closest(Selectors.editors.all);\n          let key = element.getAttribute(\"data-key\");\n\n          saveTranslation(key, editor, text);\n        });\n        // Remove status classes\n        editor.addEventListener(\"click\", () => {\n          editor.classList.remove(\"local-coursetranslator__success\");\n          editor.classList.remove(\"local-coursetranslator__error\");\n        });\n      });\n  });\n\n  /**\n   * Get text from processing areas and add them to contenteditables\n   */\n  window.addEventListener(\"load\", () => {\n    let textareas = document.querySelectorAll(Selectors.editors.textarea);\n    textareas.forEach((textarea) => {\n      // Get relevent keys and text\n      let key = textarea.getAttribute(\"data-key\");\n      let text = textarea.innerHTML;\n      /**\n       * @todo review selector\n       */\n      let editor = document.querySelector(\n          Selectors.editors.multiples.contentEditableKeys\n              .replace(\"<KEY>\", key));\n\n      let langpattern = `{mlang ${config.lang}}(.*?){mlang}`;\n      let langex = new RegExp(langpattern, \"dgis\");\n      let matches = text.match(langex);\n\n      // Parse the text for mlang\n      let parsedtext = mlangparser(text);\n\n      if (matches && matches.length === 1) {\n        // Updated contenteditables with parsedtext\n        editor.innerHTML = parsedtext;\n      } else if (matches && matches.length > 1) {\n        //const dataKey = `data-key=\"${key}\"`;\n        document.querySelector(Selectors.editors.multiples.checkBoxesWithKey\n            .replace('<KEY>', key)).remove();\n        document.querySelector(Selectors.editors.multiples.editorChilds\n            .replace('<KEY>', key)).remove();\n        document.querySelector(Selectors.editors.multiples.textAreas\n            .replace('<KEY>', key)).remove();\n        let p = document.createElement(\"p\");\n        p.innerHTML = `<em><small>${config.multiplemlang}</small></em>`;\n        document.querySelector(Selectors.editors.multiples.editorsWithKey\n            .replace('<KEY>', key)).append(p);\n      } else {\n        editor.innerHTML = parsedtext;\n      }\n    });\n  });\n};\n\n/**\n * Eventlistener for show update checkbox\n * @param {Event} e\n */\nconst showUpdated = (e) =>{\n  let items = document.querySelectorAll(Selectors.statuses.updated);\n  if (e.target.checked) {\n    items.forEach((item) => {\n      item.classList.remove(\"d-none\");\n    });\n  } else {\n    items.forEach((item) => {\n      item.classList.add(\"d-none\");\n    });\n  }\n};\n\n/**\n * Event listener to switch target lang\n * @param {Event} e\n */\nconst switchTarget = (e) => {\n  window.console.info('switchTarget');\n  let url = new URL(window.location.href);\n  let searchParams = url.searchParams;\n  searchParams.set(\"target_lang\", e.target.value);\n  let newUrl = url.toString();\n  window.location = newUrl;\n};\n/**\n * Event listener to switch source lang\n * Hence reload the page and change the site main lang\n * @param {Event} e\n */\nconst switchSource = (e) => {\n  window.console.info('switchSource');\n  let url = new URL(window.location.href);\n  let searchParams = url.searchParams;\n  searchParams.set(\"lang\", e.target.value);\n  let newUrl = url.toString();\n  window.location = newUrl;\n};\n/**\n * Event listener to check if update are needed\n * @param {Event} e\n */\nconst neededUpdate = (e)=> {\n  window.console.info(\"Need update toggled\");\n  window.console.info(\"source_lang\", config.currentlang);\n  window.console.info(\"target_lang\", config.lang);\n\n  let items = document.querySelectorAll(Selectors.statuses.needsupdate);\n  if (e.target.checked) {\n    items.forEach((item) => {\n      item.classList.remove(\"d-none\");\n    });\n  } else {\n    items.forEach((item) => {\n      item.classList.add(\"d-none\");\n    });\n  }\n};\n\n/**\n * Launch autotranslation\n * @todo should do in call to the API\n */\nconst doAutotranslate = () => {\n  document\n      // .querySelectorAll(\".local-coursetranslator__checkbox:checked\")\n      .querySelectorAll(Selectors.statuses.checkedCheckBoxes)\n      .forEach((ckBox) => {\n        let key = ckBox.getAttribute(\"data-key\");\n        getTranslation(key);\n      });\n};\n/**\n * Send for Translation to DeepL\n * @param {Integer} key Translation Key\n */\nconst getTranslation = (key) => {\n  // Store the key in the dictionary\n  tempTranslations[key] = {};\n  // Get the editor\n  let editor = findEditor(key);\n\n  // Get the source text\n  let sourceText = document.querySelector(Selectors.sourcetexts.keys.replace(\"<KEY>\",key))\n      .innerHTML;\n  // Initialize global dictionary with this key's editor\n  tempTranslations[key] = {\n    'editor': editor,\n    'source': sourceText,\n    'translation': ''\n  };\n  // Build formData\n  let formData = new FormData();\n  formData.append(\"text\", sourceText);\n  // FormData.append(\"source_lang\", \"en\");\n  formData.append(\"source_lang\", config.currentlang.toUpperCase());\n  formData.append(\"target_lang\", config.lang.toUpperCase());\n  formData.append(\"auth_key\", config.apikey);\n  formData.append(\"tag_handling\", document.querySelector(Selectors.deepl.tag_handling).checked?'html': 'xml');//\n  formData.append(\"context\", document.querySelector(Selectors.deepl.context).value??null); //\n  formData.append(\"split_sentences\", document.querySelector(Selectors.deepl.split_sentences).value);//\n  formData.append(\"preserve_formatting\", document.querySelector(Selectors.deepl.preserve_formatting).checked);//\n  formData.append(\"formality\", document.querySelector(Selectors.deepl.formality).value);//\n  formData.append(\"glossary_id\", document.querySelector(Selectors.deepl.glossary_id).value);//\n  formData.append(\"outline_detection\", document.querySelector(Selectors.deepl.outline_detection).checked);//\n  formData.append(\"non_splitting_tags\", toJsonArray(document.querySelector(Selectors.deepl.non_splitting_tags).value));\n  formData.append(\"splitting_tags\", toJsonArray(document.querySelector(Selectors.deepl.splitting_tags).value));\n  formData.append(\"ignore_tags\", toJsonArray(document.querySelector(Selectors.deepl.ignore_tags).value));\n\n  // Window.console.log(config.currentlang);\n   window.console.log(\"Send deepl:\", formData);\n  // Update the translation\n  let xhr = new XMLHttpRequest();\n  xhr.onreadystatechange = () => {\n    if (xhr.readyState === XMLHttpRequest.DONE) {\n      const status = xhr.status;\n      if (status === 0 || (status >= 200 && status < 400)) {\n        // The request has been completed successfully\n        let data = JSON.parse(xhr.responseText);\n        window.console.log(\"deepl:\", key, data);\n        // Window.console.log(config.currentlang);\n        // window.console.log(editor);\n        // Display translation\n        editor.innerHTML = data.translations[0].text;\n        // Save translation\n        // saveTranslation(key, editor, data.translations[0].text);\n        // store the translation in the global object\n        tempTranslations[key].translation = data.translations[0].text;\n      } else {\n        // Oh no! There has been an error with the request!\n        window.console.log(\"error\", status);\n      }\n    }\n  };\n   xhr.open(\"POST\", config.deeplurl);\n   xhr.send(formData);\n};\n/**\n * Get the editor container based on recieved current user's\n * editor preference.\n * @param {Integer} key Translation Key\n */\nconst findEditor = (key) => {\n  // Let q = '';\n  // window.console.log(\"document.querySelector('\" + q + \"')\");\n  // window.console.log(\"editors pref : \" + editorType);\n  switch (editorType) {\n    case \"atto\" :\n      return document.querySelector(\n          Selectors.editors.types.atto\n              .replace(\"<KEY>\",key));\n    case \"tiny\":\n      return document.querySelector(Selectors.editors.types.tiny\n          .replace(\"<KEY>\",key))\n          .contentWindow.tinymce;\n    case 'marklar':\n    case \"textarea\" :\n      return document.querySelector(Selectors.editors.types.other\n          .replace(\"<KEY>\",key));\n  }\n};\n/**\n *\n * @param {Event} e\n */\nconst selectAll = (e)=>{\n  // See if select all is checked\n  let checked = e.target.checked;\n\n  // Check/uncheck checkboxes\n  if (checked) {\n    checkboxes.forEach((e) => {\n      e.checked = true;\n    });\n  } else {\n    checkboxes.forEach((e) => {\n      e.checked = false;\n    });\n  }\n  toggleAutotranslateButton();\n};\n/**\n * Toggle Autotranslate Button\n */\nconst toggleAutotranslateButton = () => {\n  let checkboxItems = [];\n  checkboxes.forEach((e) => {\n    checkboxItems.push(e.checked);\n  });\n  let checked = checkboxItems.find((checked) => checked === true)\n      ? true\n      : false;\n  if (config.autotranslate && checked) {\n    autotranslateButton.disabled = false;\n  } else {\n    autotranslateButton.disabled = true;\n  }\n};\nconst toJsonArray = (s, sep=\",\") => {\n  return JSON.stringify(s.split(sep));\n};\n"],"names":["tempTranslations","editorType","config","autotranslateButton","checkboxes","cfg","userPrefs","document","querySelector","Selectors","actions","autoTranslateBtn","querySelectorAll","checkBoxes","window","console","log","statuses","checkedCheckBoxes","addEventListener","e","target","closest","targetSwitcher","switchTarget","sourceSwitcher","switchSource","showUpdated","showNeedUpdate","neededUpdate","currentlang","lang","undefined","create","title","body","show","removeOnClose","doAutotranslate","selecAllBtn","selectAll","searchex","mlangparser","text","match","result","replace","blocklang","split","blocktext","replacecallback","length","mlangex","RegExp","matches","autotranslate","disabled","validatorsBtns","forEach","key","parentElement","dataset","keyValidator","saveTranslation","editor","innerHTML","toggleAutotranslateButton","element","editors","all","id","getAttribute","tid","table","field","fielddata","courseid","parseInt","call","methodname","args","data","done","fieldtext","textarea","multiples","textAreas","updatedtext","getupdatedtext","tdata","successMessage","classList","add","indicator","autosavedmsg","after","string","parser","DOMParser","parseFromString","err","childNodes","dom","createElement","stringToHTML","status","keys","uptodate","setTimeout","indicatorNode","successMessages","parentNode","removeChild","errorMessage","error","debug","sourcetexts","fail","mlangtext","indexOf","replacex","updatedString","contentEditable","remove","contentEditableKeys","langpattern","langex","parsedtext","checkBoxesWithKey","editorChilds","p","multiplemlang","editorsWithKey","append","items","updated","checked","item","info","url","URL","location","href","searchParams","set","value","newUrl","toString","needsupdate","ckBox","getTranslation","findEditor","sourceText","formData","FormData","toUpperCase","apikey","deepl","tag_handling","context","split_sentences","preserve_formatting","formality","glossary_id","outline_detection","toJsonArray","non_splitting_tags","splitting_tags","ignore_tags","xhr","XMLHttpRequest","onreadystatechange","readyState","DONE","JSON","parse","responseText","translations","translation","open","deeplurl","send","types","atto","tiny","contentWindow","tinymce","other","checkboxItems","push","find","s","sep","stringify"],"mappings":"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"}